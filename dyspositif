#!/usr/bin/env bash
# dyspositif – Point d'entrée officiel Dys’Positif (v1.0.0-pro)
set -euo pipefail

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV="$DIR/venv"

# Création silencieuse du venv
if [ ! -d "$VENV" ]; then
    echo "Création de l'environnement virtuel..."
    python3 -m venv "$VENV" --quiet
fi

source "$VENV/bin/activate"

# Nettoyage propre de PYTHONPATH corrompu
if [[ -n "${PYTHONPATH-}" ]]; then
    if [[ "$PYTHONPATH" == *"::"* || "$PYTHONPATH" == *":$"* || "$PYTHONPATH" == "$" ]]; then
        unset PYTHONPATH
    fi
fi

# Mise à jour silencieuse
pip install --quiet --upgrade pip

# Installation pylirecouleur local
if ls "$DIR/pylirecouleur/dist"/pylirecouleur-*.whl 1> /dev/null 2>&1; then
    pip install --quiet --force-reinstall --no-index "$DIR/pylirecouleur/dist"/pylirecouleur-*.whl
fi

# Dépendances PyPI
pip install --quiet python-docx==1.1.2 lxml==5.3.0 Pillow==10.4.0 pdfservices-sdk

# PYTHONPATH propre et sécurisé
export PYTHONPATH="$DIR/pylirecouleur/src${PYTHONPATH:+:$PYTHONPATH}"

# Lancement propre
if [[ " $* " == *" --verbose "* ]]; then
    exec python "$DIR/main.py" "$@"
else
    exec python "$DIR/main.py" "$@" 2>/dev/null || {
        echo "Une erreur est survenue."
        echo "Consultez le journal : ~/.cache/dys_positif/dys.log"
        echo "Ou lancez avec : ./dyspositif --verbose"
        exit 1
    }
fi